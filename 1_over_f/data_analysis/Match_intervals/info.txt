This is adpated from Ramesh's code.
Copied from:
/ssd/zhibin/1overf/20220808_2P/Copy_of_Ramesh20220909